// Dados dos c√¢nticos organizados por pasta
const canticosData = {
    "1 - Entrada": [
        "Entrada - Creio.jpeg",
        "Entrada - Eu e Minha Casa Serviremos ao Senhor.pdf",
        "Entrada - Por Entre Aclama√ß√µes.pdf",
        "Entrada - Vamos Celebrar.pdf",
        "Oh senhor nos estamos aqui.jpeg",
        "a_biblia_e_a_palavra_de_deus.pdf",
        "bom_pastor.pdf",
        "cora√ß√£o_santo.pdf",
        "cristo_ressucitou_aleluia.pdf",
        "deixa_a_luz_do_ceu_entrar.pdf",
        "eis_me_aqui_senhor.pdf",
        "estaremos_aqui_reunidos.pdf",
        "faco_novas_todas_as_coisas.pdf",
        "hosana_hey_hosana_ha.pdf",
        "por_sua_morte.pdf",
        "porque_ele_vive.pdf",
        "senhor_quem_entrara.pdf",
        "te_amarei.pdf",
        "toda_biblia_e_comunicacao.pdf",
        "tu_es_a_razao_da_jornada.pdf",
        "vem_louvar.pdf"
    ],
    "2 - Ato Penitencial": [
        "Eu confesso a Deus.jpeg",
        "Piedade - Senhor que viestes salvar.jpeg",
        "conheco_um_coracao.pdf",
        "coracoes_arrependidos.pdf",
        "kyrie_eleison_jmj.pdf",
        "pelos_pecados_senhor_piedade_de_nos.pdf",
        "perdao_senhor.pdf",
        "renovame.pdf",
        "renovame_ii.pdf",
        "senhor_que_viestes_salvar_kirie_elleisson.pdf",
        "senhor_tende_piedade_de_nos.pdf",
        "senhor_tende_piedade_perdoai_nossa_culpa.pdf"
    ],
    "3 - Gl√≥ria": [
        "Gloria - Gloria a Deus nas alturas.jpeg",
        "Gloria - continua√ß√£o.jpeg",
        "Gloria a Deus.jpeg",
        "a_ele_seja_a_gloria.pdf",
        "gloria_a_deus_nas_alturas.pdf",
        "gloria_a_deus_nas_alturas__rock_balada.pdf",
        "gloria_ao_pai_criador.pdf"
    ],
    "5 - Aclama√ß√£o Evangelho": [
        "Aclama√ß√£o - A vossa palavra senhor.jpeg",
        "a_minhalma_abrirei.pdf",
        "a_vossa_palavra_senhor.pdf",
        "aleluia_como_o_pai_me_amou.pdf",
        "buscai_primeiro_o_reino_de_deus.pdf",
        "como_sao_belos.pdf",
        "eu_vim_para_escutar.pdf",
        "palavra_de_salvacao.pdf",
        "que_alegria_cristo_ressurgiu.pdf",
        "vai_falar_no_evangelho.pdf",
        "vinde_espirito_de_deus.pdf"
    ],
    "6 - Ofert√≥rio": [
        "Ofertorio - Os dons que trago aqui.jpeg",
        "a_mesa_santa_que_preparamos.pdf",
        "de_maos_estendidas.pdf",
        "meu_coracao_eh_para_ti.pdf",
        "minha_vida_tem_sentido.pdf",
        "muitos_graos_de_trigo.pdf",
        "ofertas_singelas.pdf",
        "sabes_senhor.pdf",
        "um_coracao_para_amar.pdf"
    ],
    "7 - Santo": [
        "Nosso Deus senhor √© santo.jpeg",
        "Santo - Santo santo santo √©h o senhor.jpeg",
        "hosana_eh.pdf",
        "hosana_no_alto_ceu.pdf",
        "o_senhor_eh_santo.pdf",
        "santo_santo_e.pdf"
    ],
    "8 - Cordeiro de Deus": [
        "cordeiro_do_maior.pdf"
    ],
    "9 - Comunh√£o": [
        "Comunh√£o - Eis que sou o p√£o da vida.jpeg",
        "Comunh√£o - Presen√ßa Linda.pdf",
        "a_barca.pdf",
        "a_ti_meu_deus.pdf",
        "antes_da_morte_e_ressurreicao.pdf",
        "cantar_a_beleza_da_vida.pdf",
        "como_es_lindo.pdf",
        "conhe√ßo_um_cora√ß√£o.pdf",
        "da_cepa_brotou_a_rama.pdf",
        "desamarrem_as_sandalias.pdf",
        "estas_entre_nos.pdf",
        "este_pranto_em_minhas_maos.pdf",
        "eu_navegarei.pdf",
        "eu_quis_comer_esta_ceia_agora.pdf",
        "eu_vim_para_que_todos_tenham_vida.pdf",
        "pelos_prados.pdf",
        "procuro_abrigo_nos_coracoes.pdf",
        "quando_teu_pai_revelou.pdf",
        "quem_nos_separara.pdf",
        "sacramento_da_comunhao.pdf",
        "sim_eu_quero.pdf",
        "sonda_me.pdf",
        "vem_eu_mostrarei.pdf",
        "vou_cantar_teu_amor.pdf"
    ],
    "10 - Final": [
        "Mostra-me senhor.jpeg",
        "a_alegria_esta_no_coracao.pdf",
        "anjos_de_deus.pdf",
        "como_o_pai_me_enviou.pdf",
        "cristo_eh_a_felicidade.pdf",
        "deixa_luz_do_ceu_entrar.pdf",
        "hoje_e_tempo_de_louvar.pdf",
        "pelas_estradas_da_vida.pdf",
        "segura_na_mao_de_deus.pdf",
        "tomado_pela_mao.pdf",
        "tu_es_razao_jornada.pdf"
    ],
    "11 - Abra√ßo de Paz": [
        "esteja_sempre_com_voce.pdf",
        "irmao_minha_paz_eu_te_dou.pdf",
        "paz_paz_de_cristo.pdf"
    ],
    "12 - A√ß√£o de gra√ßas": [
        "A√ß√£o de gra√ßas - S√≥ em ti.jpeg",
        "deus_esta_aqui.pdf",
        "e_impossivel_nao_crer_em_ti.pdf",
        "espirito_santo.pdf",
        "obrigado_senhor.pdf"
    ],
    "13 - Cantos Marianos": [
        "a_escolhida.pdf",
        "ave_cheia_de_graca.pdf",
        "imaculada_maria_de_deus.pdf",
        "maria_de_nazare.pdf",
        "santa_mae_maria.pdf",
        "santa_maria_vem.pdf"
    ],
    "14 - Diversos": [
        "Consagra√ß√£o a nossa senhora.pdf",
        "Quando quero falar com Deus.jpeg",
        "podes_reinar.pdf",
        "prova_de_amor.pdf",
        "tudo_e_do_pai.pdf",
        "√â t√£o lindo falar com Deus.jpeg"
    ],
    "15 - Louvor e Medita√ß√£o": [
        "Desamarrem_as_sand√°lias.pdf",
        "a_alegria_esta_no_coracao.pdf",
        "a_nos_descei_divina_luz.pdf",
        "agua_viva.pdf",
        "amar_como_jesus_amou.pdf",
        "bate_o_sino.pdf",
        "eu_louvarei.pdf",
        "eu_quero_um_rio.pdf",
        "louvado_seja_o_meu_senhor.pdf",
        "meu_mestre__a_minha_vida_e_do_mestre.pdf",
        "noite_feliz.pdf",
        "noites_traicoeiras.pdf",
        "oracao_da_familia.pdf",
        "oracao_de_sao_francisco.pdf",
        "podes_reinar.pdf",
        "quao_grande_es_tu.pdf",
        "segura_na_mao_de_deus.pdf",
        "tao_sublime.pdf",
        "vou-cantar-teu-amor.pdf"
    ]
};

// Estado da aplica√ß√£o
let ordemMissa = [];
let quadrosRecolhidos = {};

    // Elementos DOM
let ordemMissaPanel;
let ordemLista;
let canticosContainer;
let fileModal;
let fileViewer;
let modalTitle;
let searchInput;

// Inicializa√ß√£o
document.addEventListener("DOMContentLoaded", function() {
    initializeElements();
    setupEventListeners();
    renderCanticosQuadros();
    loadOrdemMissa();
    loadQuadrosState(); // Carrega o estado dos quadros (recolhido/expandido)
});

function initializeElements() {
    ordemMissaPanel = document.getElementById("ordem-missa-panel");
    ordemLista = document.getElementById("ordem-lista");
    canticosContainer = document.querySelector(".canticos-container");
    fileModal = document.getElementById("file-modal");
    fileViewer = document.getElementById("file-viewer");
    modalTitle = document.getElementById("modal-title");
    searchInput = document.getElementById("search-input");
}

function setupEventListeners() {
    // Bot√£o de toggle da ordem da missa
    document.getElementById("ordem-missa-toggle").addEventListener("click", toggleOrdemMissa);
    
    // Bot√µes de controle da ordem da missa
    document.getElementById("salvar-ordem").addEventListener("click", salvarOrdemMissa);
    document.getElementById("carregar-ordem").addEventListener("click", carregarOrdemMissa);
    document.getElementById("limpar-ordem").addEventListener("click", limparOrdemMissa);
    document.getElementById("fechar-ordem").addEventListener("click", fecharOrdemMissa);
    
    // Modal
    document.getElementById("close-modal").addEventListener("click", closeModal);
    fileModal.addEventListener("click", function(e) {
        if (e.target === fileModal) {
            closeModal();
        }
    });
    
    // Drag and drop na √°rea de ordem da missa
    setupDropZone();

    // Campo de pesquisa
    searchInput.addEventListener("keyup", filterCanticos);
}

function renderCanticosQuadros(filterText = "") {
    canticosContainer.innerHTML = "";
    const lowerCaseFilter = filterText.toLowerCase();

    Object.keys(canticosData).forEach(pasta => {
        const filteredCanticos = canticosData[pasta].filter(cantico => 
            formatarNomeCantico(cantico).toLowerCase().includes(lowerCaseFilter)
        );

        if (filteredCanticos.length > 0) {
            const quadro = createCanticoQuadro(pasta, filteredCanticos);
            canticosContainer.appendChild(quadro);
        }
    });
}

function filterCanticos() {
    renderCanticosQuadros(searchInput.value);
}

function createCanticoQuadro(pasta, canticos) {
    const quadro = document.createElement('div');
    quadro.className = 'cantico-quadro glass-panel';
    
    const isCollapsed = quadrosRecolhidos[pasta] !== undefined ? quadrosRecolhidos[pasta] : true;
    
    quadro.innerHTML = `
        <div class="quadro-header" onclick="toggleQuadro('${pasta}')">
            <h3>${pasta}</h3>
            <span class="toggle-icon ${isCollapsed ? 'collapsed' : ''}">‚ñº</span>
        </div>
        <div class="quadro-content ${isCollapsed ? 'collapsed' : ''}">
            <ul class="canticos-lista">
                ${canticos.map(cantico => createCanticoItem(pasta, cantico)).join('')}
            </ul>
        </div>
    `;
    
    return quadro;
}

function createCanticoItem(pasta, cantico) {
    const nomeFormatado = formatarNomeCantico(cantico);
    const extensao = cantico.split('.').pop().toLowerCase();
    
    return `
        <li class="cantico-item" draggable="true" 
            ondragstart="dragStart(event, '${pasta}', '${cantico}')"
            ondragend="dragEnd(event)">
            <span class="cantico-nome">${nomeFormatado}</span>
            <div class="cantico-actions">
                <button class="action-btn" onclick="visualizarCantico('${pasta}', '${cantico}')">
                    üëÅÔ∏è Ver
                </button>
                <button class="action-btn" onclick="adicionarAOrdem('${pasta}', '${cantico}')">
                    ‚ûï Add
                </button>
            </div>
        </li>
    `;
}

function formatarNomeCantico(nomeArquivo) {
    return nomeArquivo
        .replace(/\.(pdf|jpeg|jpg)$/i, '')
        .replace(/_/g, ' ')
        .replace(/\b\w/g, l => l.toUpperCase());
}

function toggleQuadro(pasta) {
    const quadro = event.currentTarget.parentElement;
    const content = quadro.querySelector('.quadro-content');
    const icon = quadro.querySelector('.toggle-icon');
    
    const isCollapsed = content.classList.contains('collapsed');
    
    if (isCollapsed) {
        content.classList.remove('collapsed');
        icon.classList.remove('collapsed');
        quadrosRecolhidos[pasta] = false;
    } else {
        content.classList.add('collapsed');
        icon.classList.add('collapsed');
        quadrosRecolhidos[pasta] = true;
    }
    
    saveQuadrosState();
}

function toggleOrdemMissa() {
    ordemMissaPanel.classList.toggle('hidden');
}

function fecharOrdemMissa() {
    ordemMissaPanel.classList.add('hidden');
}

function visualizarCantico(pasta, cantico) {
    const githubUrl = `https://raw.githubusercontent.com/ramalhost3/missa_1.0/main/letras/${encodeURIComponent(pasta)}/${encodeURIComponent(cantico)}`;
    
    modalTitle.textContent = formatarNomeCantico(cantico);
    
    const extensao = cantico.split('.').pop().toLowerCase();
    
    console.log("URL do GitHub para o c√¢ntico:", githubUrl);
    if (extensao === 'pdf') {
        fileViewer.innerHTML = `<iframe src="https://docs.google.com/viewer?url=${encodeURIComponent(githubUrl)}&embedded=true" frameborder="0" style="width:100%; height:100%; border-radius:10px;"></iframe>`;
    } else if (extensao === 'jpeg' || extensao === 'jpg') {
        fileViewer.innerHTML = `<img src="${githubUrl}" style="max-width:100%; max-height:100%; object-fit:contain;">`;
    } else {
        fileViewer.innerHTML = `<p>Formato de arquivo n√£o suportado: ${extensao}</p>`;
    }
    
    fileModal.classList.remove('hidden');
}

function closeModal() {
    fileModal.classList.add("hidden");
    fileViewer.innerHTML = ""; // Limpa o conte√∫do do div
}

function adicionarAOrdem(pasta, cantico) {
    const item = {
        pasta: pasta,
        cantico: cantico,
        nome: formatarNomeCantico(cantico),
        id: Date.now() + Math.random()
    };
    
    ordemMissa.push(item);
    renderOrdemMissa();
    saveOrdemMissa();
    
    // Feedback visual
    showNotification('C√¢ntico adicionado √† ordem da missa!');
}

function renderOrdemMissa() {
    if (ordemMissa.length === 0) {
        ordemLista.innerHTML = `
            <div class="drop-zone">
                <p>Arraste os c√¢nticos aqui para montar a ordem da missa</p>
            </div>
        `;
        return;
    }
    
    ordemLista.innerHTML = ordemMissa.map((item, index) => `
        <div class="ordem-item" data-index="${index}">
            <div>
                <strong>${item.pasta}</strong><br>
                <span>${item.nome}</span>
            </div>
            <div>
                <button class="action-btn" onclick="visualizarCantico('${item.pasta}', '${item.cantico}')">
                    üëÅÔ∏è
                </button>
                <button class="remove-btn" onclick="removerDaOrdem(${index})">
                    ‚úï
                </button>
            </div>
        </div>
    `).join('');
}

function removerDaOrdem(index) {
    ordemMissa.splice(index, 1);
    renderOrdemMissa();
    saveOrdemMissa();
}

function limparOrdemMissa() {
    if (confirm('Tem certeza que deseja limpar toda a ordem da missa?')) {
        ordemMissa = [];
        renderOrdemMissa();
        saveOrdemMissa();
        showNotification('Ordem da missa limpa!');
    }
}

function salvarOrdemMissa() {
    const nomeArquivo = prompt('Digite um nome para salvar a ordem da missa:', 'Minha Ordem da Missa');
    if (nomeArquivo) {
        const ordens = JSON.parse(localStorage.getItem('ordensPersonalizadas') || '{}');
        ordens[nomeArquivo] = [...ordemMissa];
        localStorage.setItem('ordensPersonalizadas', JSON.stringify(ordens));
        showNotification(`Ordem "${nomeArquivo}" salva com sucesso!`);
    }
}

function carregarOrdemMissa() {
    const ordens = JSON.parse(localStorage.getItem('ordensPersonalizadas') || '{}');
    const nomes = Object.keys(ordens);
    
    if (nomes.length === 0) {
        showNotification('Nenhuma ordem salva encontrada!');
        return;
    }
    
    const opcoes = nomes.map((nome, index) => `${index + 1}. ${nome}`).join('\n');
    const escolha = prompt(`Escolha uma ordem para carregar:\n\n${opcoes}\n\nDigite o n√∫mero da op√ß√£o:`);
    
    if (escolha && !isNaN(escolha)) {
        const index = parseInt(escolha) - 1;
        if (index >= 0 && index < nomes.length) {
            const nomeEscolhido = nomes[index];
            ordemMissa = [...ordens[nomeEscolhido]];
            renderOrdemMissa();
            showNotification(`Ordem "${nomeEscolhido}" carregada!`);
        }
    }
}

function saveOrdemMissa() {
    localStorage.setItem('ordemMissaAtual', JSON.stringify(ordemMissa));
}

function loadOrdemMissa() {
    const saved = localStorage.getItem('ordemMissaAtual');
    if (saved) {
        ordemMissa = JSON.parse(saved);
        renderOrdemMissa();
    }
}

function saveQuadrosState() {
    localStorage.setItem('quadrosRecolhidos', JSON.stringify(quadrosRecolhidos));
}

function loadQuadrosState() {
    const saved = localStorage.getItem('quadrosRecolhidos');
    if (saved) {
        quadrosRecolhidos = JSON.parse(saved);
    }
}

// Drag and Drop
function dragStart(event, pasta, cantico) {
    event.dataTransfer.setData('text/plain', JSON.stringify({ pasta, cantico }));
    event.currentTarget.classList.add('dragging');
}

function dragEnd(event) {
    event.currentTarget.classList.remove('dragging');
}

function setupDropZone() {
    ordemLista.addEventListener('dragover', function(e) {
        e.preventDefault();
        if (e.currentTarget.querySelector('.drop-zone')) {
            e.currentTarget.querySelector('.drop-zone').classList.add('drag-over');
        }
    });
    
    ordemLista.addEventListener('dragleave', function(e) {
        if (e.currentTarget.querySelector('.drop-zone')) {
            e.currentTarget.querySelector('.drop-zone').classList.remove('drag-over');
        }
    });
    
    ordemLista.addEventListener('drop', function(e) {
        e.preventDefault();
        const data = JSON.parse(e.dataTransfer.getData('text/plain'));
        adicionarAOrdem(data.pasta, data.cantico);
        
        if (e.currentTarget.querySelector('.drop-zone')) {
            e.currentTarget.querySelector('.drop-zone').classList.remove('drag-over');
        }
    });
}

function showNotification(message) {
    // Criar elemento de notifica√ß√£o
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.9);
        color: #ffff00;
        padding: 15px 20px;
        border-radius: 10px;
        border: 1px solid #ffff00;
        z-index: 3000;
        font-family: 'Ubuntu Mono', monospace;
        box-shadow: 0 4px 15px rgba(255, 255, 0, 0.3);
        backdrop-filter: blur(10px);
        animation: slideIn 0.3s ease-out;
    `;
    
    // Adicionar anima√ß√£o CSS
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    `;
    document.head.appendChild(style);
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Remover ap√≥s 3 segundos
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

    if (Object.keys(quadrosRecolhidos).length === 0) {
        Object.keys(canticosData).forEach(pasta => {
            quadrosRecolhidos[pasta] = true;
        });
        saveQuadrosState();
    }

// Adicionar suporte a touch para dispositivos m√≥veis
document.addEventListener('touchstart', function() {}, { passive: true });

// Prevenir zoom em dispositivos m√≥veis
document.addEventListener('gesturestart', function(e) {
    e.preventDefault();
});

// Melhorar a experi√™ncia em dispositivos m√≥veis
if ('ontouchstart' in window) {
    document.body.classList.add('touch-device');
    
    // Adicionar CSS espec√≠fico para touch
    const touchStyle = document.createElement('style');
    touchStyle.textContent = `
        .touch-device .cantico-item:hover {
            transform: none;
        }
        .touch-device .cantico-item:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.98);
        }
        .touch-device .action-btn:active {
            transform: scale(0.95);
        }
    `;
    document.head.appendChild(touchStyle);
}

